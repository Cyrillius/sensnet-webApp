/*                                                                         ᕦ(ò_ó*)ᕤ    
*      ┗(＾0＾)┓             ##                                                          
*                        #  #                                 #                        
*                        #      ##   ###    ###  ###    ##   ####                      
*                         ##   #  #  #  #  #     #  #  #  #   #                        
*                           #  ####  #  #   ##   #  #  ####   #                        
*                        #  #  #     #  #     #  #  #  #      #                        
*                         ##    ##   #  #  ###   #  #   ##     ##                      
*                                                                                      
*                                                                                      
*                                                                                      
*      #  #                     ##               #  #        ##           #            
*      #  #                    #  #              #  #         #                        
*      #  #   ##    ###        #      ##         #  #   ###   #     ###  ##     ###    
*      ####  #  #  #    #####   ##   #  #        #  #  #  #   #    #  #   #    #       
*      #  #  ####   ##            #  #  #         ##   #  #   #    #  #   #     ##     
*      #  #  #        #        #  #  #  #         ##   # ##   #    # ##   #       #    
*      #  #   ##   ###          ##    ##          ##    # #  ###    # #  ###   ###     
*                                                                                      
* sensnet.js  V0.3  (2015-01-15, 06:52)       
*                                                                                      
* Cyril Praz                                                                           
*/
                                                                                   
var Sensnet={Views:{},Collections:{},Models:{},Factories:{}};Sensnet.app=new Backbone.Marionette.Application,Sensnet.app.addRegions({header:"#sensnetHeader",tree:"#sensnetTree",body:"#sensnetBody",template:"#sensnetTemplate"}),Sensnet.app.addInitializer(function(){var a=($(window),$(document),new Sensnet.Collections.ServerCollection);Sensnet.app.servers=a,Sensnet.app.tv4=tv4,$.getJSON("schema/sensnet.schema.json",function(a){console.log("Get the JSON schema"),console.log(a),Sensnet.app.tv4.addSchema("sensnet",a)})}),Sensnet.app.on("start",function(){console.log("Sensnet App has started!"),Backbone.history&&(Sensnet.app.router=new Sensnet.Router,Backbone.history.start())}),Sensnet.app.on("onSuccess",function(a){$.jGrowl(a,{theme:"alert-success",life:4e3,animateOpen:{height:"show"}})}),Sensnet.app.on("onWarning",function(a){$.jGrowl(a,{theme:"alert-warning",life:3e3,animateOpen:{height:"show"},animateClose:{height:"hide"}})}),Sensnet.app.on("onError",function(a){$.jGrowl(a,{theme:"alert-danger",life:6e3})}),$(function(){$("#content").load("template/template.html",function(){Sensnet.app.start()})}),function(a,b){b.app.views={};var c=a.Marionette.AppRouter.extend({routes:{welcome:"welcome",home:"home",addServer:"addServer","server/:serverId":"server","server/:serverId/device/:deviceId":"device","server/:serverId/device/:deviceId/sensor/:sensorId":"sensor",servers:"servers","server/:serverId/devices":"devices","server/:serverId/device/:deviceId/sensors":"sensors","*actions":"welcome"},welcome:function(){var a=b.Factories.Home.welcomeBody();b.app.body.show(a),a.innerWelcome.show(b.Factories.Server.addServerForm())},home:function(){b.app.body.show(b.Factories.Home.homeBody()),b.app.tree.show(b.Factories.Home.homeSide())},addServer:function(){b.app.tree.show(b.Factories.Home.homeSide());var a=b.Factories.Server.addServerForm();b.app.body.show(a)},server:function(a){b.app.tree.show(b.Factories.Home.homeSide());var c=b.Factories.Server.serverBody(a);b.app.body.show(c)},device:function(a,c){console.log("navigate to the device! Bitch!"),b.app.tree.show(b.Factories.Home.homeSide());var d=b.Factories.Device.deviceBody(a,c);b.app.body.show(d)},sensor:function(a,c,d){b.app.tree.show(b.Factories.Home.homeSide());var e=b.Factories.Sensor.sensorBody(a,c,d);b.app.body.show(e)},servers:function(){b.app.tree.show(b.Factories.Home.homeSide());var a=b.Factories.Server.serversBody();b.app.body.show(a)},devices:function(a){b.app.tree.show(b.Factories.Home.homeSide());var c=b.Factories.Device.devicesBody(a);b.app.body.show(c)},sensors:function(a,c){b.app.tree.show(b.Factories.Home.homeSide());var d=b.Factories.Sensor.sensorsBody(a,c);b.app.body.show(d)}});b.Router=c}(Backbone,Sensnet),function(a,b){b.Test={};var c={event:"onInit",devices:[{mac:"FF: FF: FF: FF: FF",sensors:[{type:"temperature",value:"20"},{type:"motion",value:"0"}]},{mac:"FF: FF: FF: FF: FF",sensors:[{type:"temperature",value:"20"},{type:"motion",value:"0"}]},{mac:"FF: FF: FF: FF: FF",sensors:[{type:"temperature",value:"20"},{type:"motion",value:"0"}]},{mac:"FF: FF: FF: FF: FF",sensors:[{type:"temperature",value:"20"},{type:"motion",value:"0"}]}]};b.Test.onInitMsg=c}(Backbone,Sensnet),function(a,b){var c=a.Model.extend({initialize:function(){this.set({sensorId:this.cid}),this.set({name:"Sensor "+this.get("port")})},defaults:{type:"",port:"",value:0,unit:"unknow",model:"sensor"},setUrl:function(a){this.set({url:a})},toJSON:function(){var b=a.Model.prototype.toJSON.call(this);return b.name=this.get("name"),b.mac=this.get("mac"),b.port=this.get("port"),b}});b.Models.Sensor=c}(Backbone,Sensnet),function(a,b){var c=a.Collection.extend({model:b.Models.Sensor});b.Collections.SensorCollection=c}(Backbone,Sensnet),function(a,b){var c=a.Model.extend({initialize:function(){this.set({deviceId:this.cid}),this.set({name:this.get("mac")});var a=this.get("sensors");if(null===a||void 0===a){var c=new b.Collections.SensorCollection;this.set({sensors:c})}if(a=this.get("sensors"),!(a instanceof b.Collections.SensorCollection)){var d=new b.Collections.SensorCollection(a);this.set({sensors:d})}},defaults:{mac:"",model:"device"},setUrl:function(a){this.set({url:a});var b=this.get("sensors");b.forEach(function(b){b.setUrl(a+"/sensor/"+b.get("sensorId"))})},toJSON:function(){var b=a.Model.prototype.toJSON.call(this);return b.name=this.get("name"),b.mac=this.get("mac"),b.sensors=this.get("sensors"),b}});b.Models.Device=c}(Backbone,Sensnet),function(a,b){var c=a.Collection.extend({model:b.Models.Device});b.Collections.DeviceCollection=c}(Backbone,Sensnet),function(a,b,c){var d=a.Model.extend({initialize:function(){this.set({serverId:this.cid});var a=this.get("name");a||this.set({name:"Server "+this.get("serverId")}),"http:"==window.location.protocol&&this.set({port:80});var c=this.get("devices");if(null===c||void 0===c){var d=new b.Collections.DeviceCollection;this.set("devices",d)}if(!(c instanceof b.Collections.DeviceCollection)){var e=new b.Collections.DeviceCollection(c);this.set({devices:e})}this.setUrl("server/"+this.get("serverId"))},defaults:{ip:document.location.hostname,port:document.location.port,status:"unknow",model:"server"},setUrl:function(a){this.set({url:a});var b=this.get("devices");b.forEach(function(b){b.setUrl(a+"/device/"+b.get("deviceId"))})},toJSON:function(){var b=a.Model.prototype.toJSON.call(this);return b.name=this.get("name"),b.ip=this.get("ip"),b.port=this.get("port"),b},initSocket:function(){this.addr="ws://"+this.get("ip")+":"+this.get("port"),this.stream=b.Factories.Connection.websocket(this,this.addr),this.on("socket_open",this.socketOpen,this),this.on("socket_close",this.socketClose,this),this.on("socket_error",this.socketError,this),this.on("socket_message",this.socketMessage,this)},socketOpen:function(){c.log("socketOpen"),b.app.trigger("onSuccess","The connection with "+this.addr+" is now open"),this.trigger("onConnectionSuccess"),this.set("status","connected")},socketClose:function(){c.log("socketClose"),b.app.trigger("onWarning","The connection with "+this.addr+" is close"),this.set("status","disconnected")},socketError:function(){c.log("socketError"),b.app.trigger("onError","An Error has just happen with "+this.addr+" !"),this.trigger("onConnectionFailed"),this.set("status","error")},socketMessage:function(a){var d=b.app.tv4.validate(a,b.app.tv4.getSchema("sensnet"));if(d)switch(a.event){case"onInit":c.log(a),this.set({devices:new b.Collections.DeviceCollection(a.devices)}),this.setUrl("server/"+this.get("serverId"));break;case"onDeviceChange":c.log(a);var e=this.get("devices").where({mac:a.device.mac});if(e.length>=1){e[0].set({mac:a.device.mac});var f=e[0].get("sensors").models;f.length>=2&&(f[0].set(a.device.sensors[0]),f[1].set(a.device.sensors[1]))}break;case"onSensorChange":c.log(a);var g=this.get("devices").where({mac:a.mac});if(g.length>=1){var h=g[0].get("sensors").where({port:a.sensor.port});h.length>=1&&h[0].set(a.sensor)}}else c.log("the message received is invalid!"),c.log(b.app.tv4.error),c.log(a),this.stream.send(b.app.tv4.error)}});b.Models.Server=d}(Backbone,Sensnet,console),function(a,b){var c=a.Collection.extend({model:b.Models.Server});b.Collections.ServerCollection=c}(Backbone,Sensnet),function(a,b){var c=a.Marionette.LayoutView.extend({template:"#welcome-template",regions:{innerWelcome:"#inner-welcome"}});b.Views.WelcomeView=c}(Backbone,Sensnet),function(a,b,c){var d=Marionette.ItemView.extend({template:"#device-table",modelEvents:{change:"render",sync:"render"},onRender:function(){console.log("table was rendered")}});c.Views.VDeviceTable=d;var e=a.Marionette.CollectionView.extend({childView:c.Views.VDeviceTable});c.Views.VDevicesTable=e}(Backbone,_,Sensnet),function(a,b,c){var d=Marionette.ItemView.extend({template:"#sensor-table",modelEvents:{change:"render",sync:"render"},onRender:function(){console.log("table was rendered")}});c.Views.VSensorTable=d;var e=a.Marionette.CollectionView.extend({childView:c.Views.VSensorTable});c.Views.VSensorsTable=e}(Backbone,_,Sensnet),function(a,b,c){var d=Marionette.ItemView.extend({template:"#server-profile",tagName:"form",events:{"click .save":"saveForm"},initialize:function(){this.model=new c.Models.Server},saveForm:function(){var a=$("#serverName").val(),b=$("#serverIp").val(),d=$("#serverPort").val(),e=this.model,f=c.app.servers.findWhere({ip:b,port:d});null!==f&&void 0!==f?(e.trigger("destroy",this.model),e=f,e.set({name:a})):e.set({name:a,ip:b,port:d}),e.initSocket(),e.on("onConnectionSuccess",function(){c.app.servers.add(e),c.app.router.navigate("home",{trigger:!0})}),e.on("onConnectionFailed",function(){e.trigger("destroy",this.model)})}});c.Views.VServerProfile=d;var e=Marionette.ItemView.extend({template:"#server-table",modelEvents:{change:"render",sync:"render"},events:{"click .delete-server":"deleteServer"},onRender:function(){console.log("table was rendered")},deleteServer:function(){this.model.trigger("destroy",this.model)}});c.Views.VServerTable=e;var f=a.Marionette.CollectionView.extend({childView:c.Views.VServerTable});c.Views.VServersTable=f}(Backbone,_,Sensnet),function(a,b){var c=a.Marionette.ItemView.extend({template:"#node-template",modelEvents:{change:"render",sync:"render"},events:{"click .display.sensor":"displaySensor"},tagName:"ul",className:"tree sensor",displaySensor:function(){b.app.router.navigate(this.model.get("url"),{trigger:!0})},onRender:function(){console.log("sensor was rendered"),this.$(".display.sensor span").addClass("new"),setTimeout(function(){this.$(".display.sensor span").removeClass("new")},500)}});b.Views.SensorsViewTree=c;var d=a.Marionette.CompositeView.extend({template:"#node-template",modelEvents:{},collectionEvents:{},events:{"click .display.device":"displayDevice"},tagName:"ul",className:"tree device",childView:b.Views.SensorsViewTree,initialize:function(){this.collection=this.model.get("sensors")},displayDevice:function(){console.log("BOUM2!!!"),b.app.router.navigate(this.model.get("url"),{trigger:!0})},onRender:function(){console.log("tree was rendered"),$(".display.device span").addClass("new"),setTimeout(function(){jQuery(".display.device span").removeClass("new")},500)},attachHtml:function(a,b){a.$("li:first").append(b.el)}});b.Views.DevicesViewTree=d;var e=a.Marionette.CompositeView.extend({template:"#node-template",modelEvents:{},collectionEvents:{},events:{"click .display.server":"displayServer"},tagName:"ul",className:"tree server",childView:b.Views.DevicesViewTree,initialize:function(){this.collection=this.model.get("devices")},displayServer:function(){b.app.router.navigate(this.model.get("url"),{trigger:!0})},onRender:function(){console.log("server was rendered"),$(".display.server span").addClass("new"),setTimeout(function(){jQuery(".display.server span").removeClass("new")},500)},attachHtml:function(a,b){a.$("li:first").append(b.el)}});b.Views.ServersViewTree=e;var f=a.Marionette.CompositeView.extend({template:"#tree-template",collectionEvents:{change:"render",sync:"render"},events:{"click .display.home":"displayHome","click .display.server-add":"displayAddServer"},childView:b.Views.ServersViewTree,displayHome:function(){b.app.router.navigate("home",{trigger:!0})},displayAddServer:function(){b.app.router.navigate("addServer",{trigger:!0})}});b.Views.TreeView=f}(Backbone,Sensnet),function(a,b,c){c.Factories.Connection={websocket:function(a,b){var c;return"undefined"!=typeof WebSocket?(console.log("Using a standard websocket"),c=new WebSocket(b)):"undefined"!=typeof MozWebSocket?(console.log("Using MozWebSocket"),c=new MozWebSocket(b)):alert("Your browser does not support websocket!"),c.onopen=function(b){a.trigger("socket_open",b)},c.onmessage=function(b){a.trigger("socket_message",JSON.parse(b.data))},c.onclose=function(b){a.trigger("socket_close",b)},c.onerror=function(b){a.trigger("socket_error",b)},c}}}(Backbone,_,Sensnet),function(a,b,c){c.Factories.Device={deviceBody:function(a,b){var d=c.app.servers.get(a),e=d.get("devices").get(b),f=new c.Views.VDeviceTable({model:e});return f},devicesBody:function(a){var b=c.app.servers.get(a),d=b.get("devices"),e=new c.Views.VDevicesTable({collection:d});return e}}}(Backbone,_,Sensnet),function(a,b,c){c.Factories.Home={homeSide:function(){var a=new c.Views.TreeView({collection:c.app.servers});return c.app.views.treeView=a,a},homeBody:function(){var a=new c.Views.VServersTable({collection:c.app.servers});return c.app.views.homeView=a,a},welcomeBody:function(){var a=new c.Views.WelcomeView;return c.app.views.welcomeView=a,a}}}(Backbone,_,Sensnet),function(a,b,c){c.Factories.Sensor={sensorBody:function(a,b,d){var e=c.app.servers.get(a),f=e.get("devices").get(b),g=f.get("sensors").get(d),h=new c.Views.VSensorTable({model:g});return h},sensorsBody:function(a,b){var d=c.app.servers.get(a),e=d.get("devices").get(b),f=e.get("sensors"),g=new c.Views.VSensorsTable({collection:f});return g}}}(Backbone,_,Sensnet),function(a,b,c){c.Factories.Server={serverBody:function(a){var b=c.app.servers.get(a),d=new c.Views.VServerTable({model:b});return d},serversBody:function(){var a=c.app.servers,b=new c.Views.VServersTable({collection:a});return b},addServerForm:function(){var a=new c.Views.VServerProfile;return a}}}(Backbone,_,Sensnet);